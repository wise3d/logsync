<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Log File Synchronizer</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 20px; background-color: #f0f2f5; color: #333; }
        .container { max-width: 1400px; margin: auto; background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { text-align: center; }
        .controls-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .control-group { padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        h3 { margin-top: 0; }
        label { font-weight: 500; margin-right: 10px; }
        input[type="file"], select, input[type="number"] { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; margin-top: 5px; }
        .main-actions { text-align: center; margin: 20px 0; }
        button { background-color: #007bff; color: white; cursor: pointer; border: none; padding: 12px 24px; font-size: 16px; border-radius: 6px; transition: background-color 0.3s; }
        button:hover:not(:disabled) { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .main-actions button:not(:last-child) { margin-right: 10px; }
        #status-container { text-align: center; margin: 20px 0; }
        #status { font-style: italic; color: #606770; }
        #results-info { font-weight: bold; color: #28a745; }
        #plot { width: 100%; min-height: 500px; }
    </style>
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Advanced Log File Synchronizer</h1>
        <div class="controls-grid">
            <div class="control-group"><h3>1. CSV File</h3><input type="file" id="csvFile" accept=".csv"><label for="csvSpeedUnits">Speed Units:</label><select id="csvSpeedUnits"><option value="kph">KM/H</option><option value="mph">MPH</option></select></div>
            <div class="control-group"><h3>2. XML File</h3><input type="file" id="xmlFile" accept=".xml"><label for="xmlSpeedUnits">Speed Units:</label><select id="xmlSpeedUnits"><option value="kph">KM/H</option><option value="mph">MPH</option></select></div>
            <div class="control-group"><h3>3. Processing Options</h3><label for="manualOffset">Manual Time Offset (s):</label><input type="number" id="manualOffset" placeholder="Optional, overrides auto-detect"><label for="resampleInterval">Resample Interval (s):</label><input type="number" id="resampleInterval" value="0.1" step="0.01"></div>
        </div>
        <div class="main-actions"><button id="processButton">Process & Synchronize</button><button id="downloadButton" style="display:none;">Download Merged CSV</button></div>
        <div id="status-container"><div id="status">Upload both files and click "Process".</div><div id="results-info"></div></div>
        <div id="plot"></div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const processButton = document.getElementById('processButton');
        const downloadButton = document.getElementById('downloadButton');
        const statusDiv = document.getElementById('status');
        const resultsInfoDiv = document.getElementById('results-info');
        let csvStringToDownload = "";
        let worker = null;

        function setStatus(message, isError = false) {
            statusDiv.textContent = message;
            statusDiv.style.color = isError ? '#d93025' : '#606770';
        }

        processButton.addEventListener('click', () => {
            if (worker) worker.terminate();

            const csvFile = document.getElementById('csvFile').files[0];
            const xmlFile = document.getElementById('xmlFile').files[0];
            if (!csvFile || !xmlFile) {
                setStatus('Please upload both CSV and XML files.', true);
                return;
            }

            setStatus('Initializing background worker...');
            resultsInfoDiv.textContent = '';
            processButton.disabled = true;
            downloadButton.style.display = 'none';
            Plotly.purge('plot');

            worker = new Worker('worker.js'); // This now works when served.
            
            worker.onmessage = (event) => {
                const { type, payload } = event.data;
                if (type === 'status') {
                    setStatus(payload);
                } else if (type === 'result') {
                    const { resampledCsv, resampledXml, timeOffset, unparseResult } = payload;
                    resultsInfoDiv.textContent = `Optimal Offset Found: ${timeOffset.toFixed(3)}s.`;
                    csvStringToDownload = unparseResult;
                    drawChart(resampledCsv, resampledXml, timeOffset);
                    downloadButton.style.display = 'inline-block';
                    setStatus('Processing complete.');
                    
                    worker.terminate();
                    processButton.disabled = false;
                } else if (type === 'error') {
                    setStatus(`ERROR: ${payload}`, true);
                    if(worker) worker.terminate();
                    processButton.disabled = false;
                }
            };

            worker.onerror = (error) => {
                setStatus(`WORKER ERROR: ${error.message}`, true);
                console.error(error);
                if (worker) worker.terminate();
                processButton.disabled = false;
            };

            const manualOffsetValue = document.getElementById('manualOffset').value;
            worker.postMessage({
                csvFile, xmlFile,
                csvSpeedUnits: document.getElementById('csvSpeedUnits').value,
                xmlSpeedUnits: document.getElementById('xmlSpeedUnits').value,
                manualOffset: (manualOffsetValue !== '' && !isNaN(manualOffsetValue)) ? parseFloat(manualOffsetValue) : null,
                resampleInterval: parseFloat(document.getElementById('resampleInterval').value) || 0.1
            });
        });

        downloadButton.addEventListener('click', () => {
            if (!csvStringToDownload) return;
            const blob = new Blob([csvStringToDownload], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'synchronized_log.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        function drawChart(resampledCsv, resampledXml, offset) {
            Plotly.newPlot('plot', [{
                x: resampledCsv.time,
                y: resampledCsv[resampledCsv._speedKey],
                name: 'CSV Speed (Resampled)', mode: 'lines'
            }, {
                x: resampledXml.time.map(t => t + offset),
                y: resampledXml[resampledXml._speedKey],
                name: 'XML Speed (Resampled & Aligned)', mode: 'lines'
            }], {
                title: 'Synchronized & Resampled Speed Data',
                xaxis: { title: 'Time (s)', rangeslider: {visible: true}},
                yaxis: { title: 'Speed (KM/H)'},
                hovermode: 'x unified'
            });
        }
    });
    </script>
</body>
</html>